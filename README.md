[![Nightly Build Status](https://github.com/midnightntwrk/midnight-node/actions/workflows/nightly-build-check.yml/badge.svg?branch=main&event=schedule)](https://github.com/midnightntwrk/midnight-node/actions/workflows/nightly-build-check.yml?query=branch%3Amain)

# Midnight Substrate Node

This is an implementation of the Midnight node. This node houses the Midnight Ledger, allowing participants of Midnight
to come to consensus on the private state.

- [Change log](changelog.md)

## Documentation

[Proposals](docs/proposals)
[Decisions](docs/decisions)

- [Configuration](docs/config.md)
- [Testing Upgrades](docs/testing-upgrades.md)
- [Substrate Chain Specifications](docs/chain_specs.md)
- [Rust Installation](docs/rust-setup.md)
- [Block Weights](docs/weights.md)
- [AWS ECR workflows for Midnight Node Docker image](docs/aws-image.md)

## Prerequisites

- For any docker steps: [Docker](https://docs.docker.com/get-docker/)
  and [Docker Compose](https://docs.docker.com/compose/install/).
- [Earthly](https://earthly.dev/get-earthly) - containerized build system
- [Direnv](https://direnv.net/docs/installation.html) - manages environment variables
- Netrc file with git credentials. See this [reference setup](https://gist.github.com/technoweenie/1072829)

## Contributing

[Guide lines on contributing](./CONTRIBUTING.md).

## Developing

Ensure you're using direnv, or source `.envrc` manually.
(For RustRover use https://plugins.jetbrains.com/plugin/15285-direnv-integration )

Common development commands are kept in the Earthfile prefixed with 'local-'. To see them all, run:

```shell
$ earthly doc
```

## How tos

### Rebuilding preprod/prod genesis

For `preprod` and `prod` chains, node keys and wallet seeds used in genesis are
stored as secrets.

It's possible to rebuild the chainspecs for `preprod` and `prod` chains without
access to the secrets, since the public keys for the initial authority nodes
are stored in `/res/$NETWORK_NAME/initial-authorities.json`. To rebuild chainspecs without rebuilding the genesis, run:

```shell
$ earthly +rebuild-chainspecs
```

If you need to re-generate the mock file for a `preprod` or `prod` chain, you'll need access to the secrets. These can
be copied from `AWS` into the `/secrets` directory. For example, for testnet these files would be:

```shell
secrets/testnet-seeds-aws.json
secrets/testnet-keys-aws.json
```

The mock file can be regenerated by running:

```shell
$ earthly +generate-keys
# Output: /res/testnet/initial-authorities.json and /res/mock-bridge-data/testnet-mock.json
```

To rebuild the genesis for a preprod environment, copy the keys from `AWS` into the `/secrets` directory and run:

```shell
# secrets copied from /secrets/testnet-genesis-seeds.json
$ earthly +rebuild-genesis
```

If you want to regenerate the genesis seeds, run:

```shell
$ earthly +generate-testnet-02-genesis-seeds
```

### How to use transaction generator

See this [document](util/generator2/README.md)

### Build Docker images

These are built in CI. See the workflow files for the latest `earthly` commands:

- [node](.github/workflows/build-publish-image.yml)
- [generator](.github/workflows/build-publish-image-generator.yml)

### Start bootstrapped local network

Start a local network with 5/7 authority node using the existing chain specification `local`

```shell
CFG_PRESET=dev SEED=//Alice ./target/release/midnight-node --base-path /tmp/node-1 --node-key="0000000000000000000000000000000000000000000000000000000000000001" --validator --port 30333
CFG_PRESET=dev SEED=//Bob ./target/release/midnight-node --base-path /tmp/node-2 --node-key="0000000000000000000000000000000000000000000000000000000000000002" --bootnodes "/ip4/127.0.0.1/tcp/30333/p2p/12D3KooWEyoppNCUx8Yx66oV9fJnriXwCcXwDDUA2kj6vnc6iDEp"  --validator --port 30334
CFG_PRESET=dev SEED=//Charlie ./target/release/midnight-node --base-path /tmp/node-3 --node-key="0000000000000000000000000000000000000000000000000000000000000003" --bootnodes "/ip4/127.0.0.1/tcp/30333/p2p/12D3KooWEyoppNCUx8Yx66oV9fJnriXwCcXwDDUA2kj6vnc6iDEp" --validator --port 30335
CFG_PRESET=dev SEED=//Dave ./target/release/midnight-node --base-path /tmp/node-4 --node-key="0000000000000000000000000000000000000000000000000000000000000004" --bootnodes "/ip4/127.0.0.1/tcp/30333/p2p/12D3KooWEyoppNCUx8Yx66oV9fJnriXwCcXwDDUA2kj6vnc6iDEp" --validator --port 30336
CFG_PRESET=dev SEED=//Eve ./target/release/midnight-node --base-path /tmp/node-5 --node-key="0000000000000000000000000000000000000000000000000000000000000005" --bootnodes "/ip4/127.0.0.1/tcp/30333/p2p/12D3KooWEyoppNCUx8Yx66oV9fJnriXwCcXwDDUA2kj6vnc6iDEp" --validator --port 30337
CFG_PRESET=dev SEED=//Ferdie ./target/release/midnight-node --base-path /tmp/node-6 --node-key="0000000000000000000000000000000000000000000000000000000000000006" --bootnodes "/ip4/127.0.0.1/tcp/30333/p2p/12D3KooWEyoppNCUx8Yx66oV9fJnriXwCcXwDDUA2kj6vnc6iDEp" --validator --port 30338
```

### How to build runtime in Docker

```shell
earthly +build
cp ./artifacts/amd64/midnight-node-runtime/midnight_node_runtime.compact.wasm .
```

### How do run dev node in Docker

```shell
docker-compose up
```

### How to generate node public keys

- For generating single keys:
    - Build node and then run:

```shell
./target/release/midnight-node key generate
```

See the `--help` flag for more information on other arguments, including key schemes.

- For generating multiple keys for bootstrapping:
    - Run the following script to generate $n$ number of key triples and seed phrases. The triples are formatted as
      Rust `enum`s for easy pasting into chain spec files, in the order: `(aura, grandpa, cross_chain)`

```shell
./scripts/keys.sh {number of authority keys to generate}
```
