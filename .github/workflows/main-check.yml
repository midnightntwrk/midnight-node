name: Ensure main green
on:
    pull_request:
        types: [opened, synchronize, reopened, ready_for_review]

permissions: {}

jobs:
  ensure-main-green:
    runs-on: ubuntu-latest
    permissions:
        contents: read
        checks: read
        statuses: read
    steps:
      - uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v8.0.0
        with:
          script: |
            const { owner, repo } = context.repo;
            const { data: { sha } } = await github.rest.repos.getCommit({ owner, repo, ref: 'main' });

            const runs = await github.paginate(github.rest.checks.listForRef, {
                owner, repo, ref: sha, filter: 'latest', per_page: 100
            });

            const completed = runs.filter(r => r.status === 'completed');
            const passed = completed.filter(r => r.conclusion === 'success');
            const failing = completed.filter(r => r.conclusion !== 'success');
            const pending = runs.length - completed.length;

            if (failing.length) {
                core.setFailed(
                'main not green on ${sha} (passed=${passed.length}, failed=${failing.length}, pending=${pending})\n' +
                failing.map(r => '- ${r.name}: ${r.html_url || r.details_url}').join('\n')
                );
            } else {
                core.info('main green on ${sha} (passed=${passed.length}, failed=0, pending=${pending})'');
            }
