name: Manual Upgrade Sequence

on:
  workflow_dispatch:
    inputs:
      network:
        description: "Target Midnight network namespace"
        required: true
        default: qanet
      # upgrade_order:
      #   description: "Execution order for runtime and client upgrades"
      #   type: choice
      #   options:
      #     - runtime-then-image
      #     - image-then-runtime
      #   default: runtime-then-image
      runtime_wasm:
        description: "Path to the runtime WASM artifact"
        required: true
      runtime_sudo_uri:
        description: "Key URI used to submit the sudo runtime upgrade"
        required: false
      runtime_delay_blocks:
        description: "Blocks to wait before submitting the runtime upgrade"
        required: false
      runtime_rpc_url:
        description: "WebSocket RPC endpoint for the runtime upgrade"
        required: false
        default: ws://localhost:9944
      node_image:
        description: "Current node image tag (NODE_IMAGE)"
        required: true
      new_node_image:
        description: "New node image tag (NEW_NODE_IMAGE)"
        required: true
      image_wait_between:
        description: "Milliseconds to wait between service restarts"
        required: false
      image_health_timeout:
        description: "Seconds to wait for container health checks"
        required: false
      snapshot_s3_endpoint_url:
        description: "Override the snapshot S3 endpoint URL (defaults to secret)"
        required: false

jobs:
  orchestrate-upgrade:
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
      S3_ENDPOINT_URL: http://localhost:9000
      S3_URI: s3://local-midnight-snapshots
      NODE_IMAGE: ${{ inputs.node_image }}
      NEW_NODE_IMAGE: ${{ inputs.new_node_image }}
      AWS_DEFAULT_REGION: ${{ secrets.MN_SNAPSHOT_S3_REGION }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: local-environment/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: local-environment

      - name: Install AWS CLI
        run: pip install awscli

      - name: Run upgrade sequence
        working-directory: local-environment
        run: |
          command="runtime-then-image"
          # if [ "${{ inputs.upgrade_order }}" = "image-then-runtime" ]; then
          #   command="image-then-runtime"
          # fi

          args=(
            "${{ inputs.network }}"
            "--runtime-wasm" "${{ inputs.runtime_wasm }}"
            "--from-snapshot" "$SNAPSHOT_KEY"
          )

          if [ -n "${{ inputs.runtime_rpc_url }}" ]; then
            args+=("--runtime-rpc-url" "${{ inputs.runtime_rpc_url }}")
          fi

          if [ -n "${{ inputs.runtime_sudo_uri }}" ]; then
            args+=("--runtime-sudo-uri" "${{ inputs.runtime_sudo_uri }}")
          fi

          if [ -n "${{ inputs.runtime_delay_blocks }}" ]; then
            args+=("--runtime-delay-blocks" "${{ inputs.runtime_delay_blocks }}")
          fi

          if [ -n "${{ inputs.image_wait_between }}" ]; then
            args+=("--image-wait-between" "${{ inputs.image_wait_between }}")
          fi

          if [ -n "${{ inputs.image_health_timeout }}" ]; then
            args+=("--image-health-timeout" "${{ inputs.image_health_timeout }}")
          fi

          if [ "${{ inputs.image_skip_health_checks }}" = 'true' ]; then
            args+=("--image-no-require-healthy")
          fi

          if [ -n "${{ inputs.compose_profiles }}" ]; then
            IFS=',' read -ra PROFILE_LIST <<< "${{ inputs.compose_profiles }}"
            trimmed_profiles=()
            for profile in "${PROFILE_LIST[@]}"; do
              value="$(echo "$profile" | xargs)"
              if [ -n "$value" ]; then
                trimmed_profiles+=("$value")
              fi
            done
            if [ ${#trimmed_profiles[@]} -gt 0 ]; then
              args+=("--profiles")
              for value in "${trimmed_profiles[@]}"; do
                args+=("$value")
              done
            fi
          fi

          if [ -n "${{ inputs.env_files }}" ]; then
            IFS=',' read -ra ENV_LIST <<< "${{ inputs.env_files }}"
            trimmed_envs=()
            for env_file in "${ENV_LIST[@]}"; do
              value="$(echo "$env_file" | xargs)"
              if [ -n "$value" ]; then
                trimmed_envs+=("$value")
              fi
            done
            if [ ${#trimmed_envs[@]} -gt 0 ]; then
              args+=("--env-file")
              for value in "${trimmed_envs[@]}"; do
                args+=("$value")
              done
            fi
          fi

          npm run "$command" -- "${args[@]}"