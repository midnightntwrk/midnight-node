name: Nightly Build Check

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  build_node:
    name: Build Node against latest
    runs-on: ubuntu-latest-8-core-x64
    timeout-minutes: 60
    env:
      FORCE_COLOR: 1
    outputs:
      node_result: ${{ steps.run_earthly.outputs.node_result }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5.0.0

      - uses: earthly/actions-setup@43211c7a0eae5344d6d79fb4aaf209c8f8866203 # v1.0.13
        with:
          version: v0.8.0
          github-token: ${{ github.token }}
          use-cache: false

      - name: Login to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef  #v3.6.0

        with:
          registry: ghcr.io
          username: MidnightCI
          password: ${{ secrets.MIDNIGHTCI_PACKAGES_WRITE }}

      - name: Cat the Cargo.toml
        run: cat ./Cargo.toml

      - name: Run check
        run: |
          mkdir -p "$HOME"/.cargo
          echo "[net]" >> "$HOME"/.cargo/config
          echo "git-fetch-with-cli = true" >> "$HOME"/.cargo/config

          # Set NETRC env var for Earthly to use for private repos
          echo "machine github.com" >> ./netrc
          echo "  login ${{secrets.MIDNIGHTCI_REPO}}" >> ./netrc
          echo "  password x-oauth-basic" >> ./netrc
          export NETRC="$(pwd)/netrc"

          . ./.envrc && earthly -P --ci --platform=linux/amd64 +node-image
